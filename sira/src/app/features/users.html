<div class="users-page">
  <!-- Toolbar -->
  <div class="toolbar card">
    <div class="left">
      <input
        type="text"
        placeholder="Rechercher utilisateur..."
        (input)="q = $any($event.target).value; applyFilters()"
      />
      <select [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">Tous</option>
        <option value="Actif">Actifs</option>
        <option value="Suspendu">Suspendus</option>
      </select>
      <button class="btn" (click)="load()">Actualiser</button>
    </div>

    <div class="right">
      <button class="btn btn-primary" (click)="openCreateDialog()">+ Nouvel utilisateur</button>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Email</th>
          <th>Âge</th>
          <th>Progression</th>
          <th>Badges</th>
          <th>Statut</th>
          <th style="width:130px">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of filteredUsers">
          <td>{{ u.firstName || u.name }} {{ u.lastName || '' }}</td>
          <td>{{ u.email }}</td>
          <td>{{ u.age || '-' }}</td>
          <td>
            <div class="progress">
              <div class="bar" [style.width.%]="(u.progress?.overall ?? 0)"></div>
            </div>
            <small class="muted">{{ (u.progress?.overall ?? 0) }}%</small>
          </td>
          <td>
            <span class="badge small" *ngFor="let b of (u.badges || [])">{{ b }}</span>
          </td>
          <td>{{ u.status }}</td>
          <td>
            <button class="btn-ghost" (click)="openViewDialog(u)">Voir</button>
            <button class="btn-danger" *ngIf="u.status === 'Actif'" (click)="suspendUser(u)">Suspendre</button>
            <button class="btn" *ngIf="u.status === 'Suspendu'" (click)="reactivateUser(u)">Réactiver</button>
          </td>
        </tr>

        <tr *ngIf="!filteredUsers?.length">
          <td colspan="7" class="muted">Aucun utilisateur trouvé.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="card little">
    <div class="meta">
      <small class="muted">Affichage {{ filteredUsers.length }} utilisateurs</small>
    </div>
  </div>
</div>

<!-- Dialog Création -->
<dialog #createDialog>
  <form (submit)="createUser($event)">
    <h3>Créer un utilisateur</h3>
    <input type="text" placeholder="Nom" [(ngModel)]="newUser.name" name="name" required />
    <input type="email" placeholder="Email" [(ngModel)]="newUser.email" name="email" required />
    <input type="number" placeholder="Âge" [(ngModel)]="newUser.age" name="age" />
    <div class="actions">
      <button type="submit" class="btn btn-primary">Créer</button>
      <button type="button" class="btn" (click)="createDialog.close()">Annuler</button>
    </div>
  </form>
</dialog>

<!-- Dialog Vue -->
<dialog #viewDialog>
  <h3>Détails utilisateur</h3>
  <p><strong>Nom : </strong>{{ selectedUser?.name }}</p>
  <p><strong>Email : </strong>{{ selectedUser?.email }}</p>
  <p><strong>Âge : </strong>{{ selectedUser?.age }}</p>
  <p><strong>Statut : </strong>{{ selectedUser?.status }}</p>
  <div class="actions">
    <button class="btn" (click)="viewDialog.close()">Fermer</button>
  </div>
</dialog>
