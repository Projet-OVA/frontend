<div class="dashboard-page">
  <div class="page-header">
    <h1>Tableau de bord</h1>
    <p>Vue d'ensemble de la plateforme SIRA</p>
  </div>

  <div *ngIf="loading" class="loading">Chargement des données...</div>

  <div *ngIf="error" class="error-card card">
    <h3>❌ Erreur</h3>
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="loadDashboardData()">Réessayer</button>
  </div>

  <!-- UTILISEZ dashboardData AU LIEU DE stats -->
  <div *ngIf="dashboardData && !loading" class="dashboard-grid">
    
    <!-- Statistiques utilisateurs -->
    <div class="card stat-card">
      <div class="stat-icon">👥</div>
      <div class="stat-content">
        <h3>{{ dashboardData.userStats.totalUsers }}</h3>
        <p>Utilisateurs total</p>
        <small>{{ dashboardData.userStats.activeUsers }} actifs</small>
      </div>
    </div>

    <!-- Événements -->
    <div class="card stat-card">
      <div class="stat-icon">🎯</div>
      <div class="stat-content">
        <h3>{{ dashboardData.eventStats.totalEvents }}</h3>
        <p>Événements</p>
      </div>
    </div>

    <!-- Badges -->
    <div class="card stat-card">
      <div class="stat-icon">🏆</div>
      <div class="stat-content">
        <h3>{{ dashboardData.badgeStats.totalBadges }}</h3>
        <p>Badges attribués</p>
      </div>
    </div>

    <!-- Progression cours -->
    <div class="card stat-card">
      <div class="stat-icon">📚</div>
      <div class="stat-content">
        <h3 [style.color]="getProgressColor(parseFloat(dashboardData.courseProgress.completionRate))">
          {{ formatPercentage(dashboardData.courseProgress.completionRate) }}
        </h3>
        <p>Complétion cours</p>
        <small [class.positive]="dashboardData.courseProgress.completionRateChange.includes('+')"
               [class.negative]="dashboardData.courseProgress.completionRateChange.includes('-')">
          {{ dashboardData.courseProgress.completionRateChange }}
        </small>
      </div>
    </div>

    <!-- Engagement communauté -->
    <div class="card stat-card">
      <div class="stat-icon">💬</div>
      <div class="stat-content">
        <h3>{{ formatPercentage(dashboardData.communityEngagement.engagementRate) }}</h3>
        <p>Engagement</p>
        <small [class.positive]="dashboardData.communityEngagement.engagementRateChange.includes('+')"
               [class.negative]="dashboardData.communityEngagement.engagementRateChange.includes('-')">
          {{ dashboardData.communityEngagement.engagementRateChange }}
        </small>
      </div>
    </div>
  </div>

  <!-- Diagramme circulaire des badges - VERSION SIMPLIFIÉE -->
   
  <div *ngIf="dashboardData?.badgeStats?.badgeDistribution && badgeChartData.length > 0" class="badge-chart-container">
    <div class="badge-chart-header">
      <h2>🏆 Distribution des Badges</h2>
      <p>Répartition des badges par catégorie</p>
    </div>
    
    <div class="chart-content">
      <div class="pie-chart">
        <svg width="300" height="300" viewBox="0 0 300 300">
          <!-- Génération simplifiée des segments -->
          <circle 
            *ngFor="let badge of badgeChartData; let i = index; trackBy: trackByIndex"
            cx="150" 
            cy="150" 
            r="80" 
            fill="none" 
            [attr.stroke]="badge.color"
            stroke-width="40"
            [attr.stroke-dasharray]="badge.strokeDasharray"
            [attr.stroke-dashoffset]="badge.strokeDashoffset"
            transform="rotate(-90 150 150)" 
            class="pie-slice"
            [style.--dash-array]="badge.strokeDasharray.split(' ')[0]">
          </circle>
        </svg>
        
        <div class="chart-center">
          <div class="total-badges">{{ getTotalBadges() }}</div>
          <div class="total-label">Total</div>
        </div>
      </div>
      
      <div class="badge-legend">
        <div 
          *ngFor="let badge of badgeChartData; trackBy: trackByIndex" 
          class="legend-item"
          [style.--badge-color]="badge.color">
          <div class="legend-color"></div>
          <div class="legend-info">
            <div class="legend-label">{{ badge.key }}</div>
            <div class="legend-count">{{ badge.count }}</div>
            <div class="legend-percentage">{{ badge.percentage.toFixed(1) }}% du total</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section progression utilisateur -->
  <div *ngIf="userProgress" class="card progress-section">
    <h2>📊 Progression Utilisateur</h2>
    
    <div class="overall-progress">
      <div class="progress-bar">
        <div class="progress-fill" [style.width]="userProgress.data.overallProgress + '%'"></div>
      </div>
      <span class="progress-text">{{ userProgress.data.overallProgress }}% complété</span>
    </div>

    <div class="categories-grid">
      <div *ngFor="let category of userProgress.data.categories" class="category-card">
        <h4>{{ category.category }}</h4>
        <div class="progress-bar small">
          <div class="progress-fill" 
               [style.width]="category.progressPercentage + '%'"
               [style.background]="getProgressColor(category.progressPercentage)"></div>
        </div>
        <p>{{ category.completedQuizzes }}/{{ category.totalQuizzes }} quiz complétés</p>
        <span class="percentage">{{ category.progressPercentage }}%</span>
      </div>
    </div>
  </div>

  <!-- Fallback si pas de données de badges -->
  <div *ngIf="!dashboardData?.badgeStats?.badgeDistribution || badgeChartData.length === 0" class="badge-chart-container">
    <div class="badge-chart-header">
      <h2>🏆 Distribution des Badges</h2>
      <p>Aucune donnée disponible</p>
    </div>
    <div class="chart-content">
      <div class="no-data">
        <p>Aucune donnée de badges à afficher pour le moment.</p>
      </div>
    </div>
  </div>

</div>