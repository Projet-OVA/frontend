<!-- src/app/features/dashboard.html -->
<div class="dashboard-page">
  <header class="header">
    <div class="header-left">
      <h1>✨ Tableau de bord</h1>
      <p class="subtitle">Aperçu global — utilisateurs, badges, progression & engagement</p>
    </div>
    <div class="header-actions">
      <button class="btn-ghost" (click)="refresh()">🔄 Actualiser</button>
    </div>
  </header>

  <main class="grid">
    <!-- TOP METRICS -->
    <section class="metrics">
      <div class="card metric-card pulse">
        <div class="metric-title">Utilisateurs totaux</div>
        <div class="metric-value">{{ totalUsers | number }}</div>
        <div class="metric-sub">Actifs : {{ activeUsers | number }}</div>
      </div>

      <div class="card metric-card pulse delay">
        <div class="metric-title">Événements</div>
        <div class="metric-value">{{ totalEvents }}</div>
        <div class="metric-sub">Organisés / enregistrés</div>
      </div>

      <div class="card metric-card pulse delay-more">
        <div class="metric-title">Badges attribués</div>
        <div class="metric-value">{{ totalBadges }}</div>
        <div class="metric-sub">Répartition dans le camembert</div>
      </div>

      <div class="card metric-card">
        <div class="metric-title">Engagement</div>
        <div class="metric-value">{{ engagementRate }}</div>
        <div class="metric-sub">
          Variation: {{ dashboard?.communityEngagement?.engagementRateChange }}
        </div>
      </div>
    </section>

    <!-- CHARTS ROW -->
    <section class="charts-row">
      <div class="card wide">
        <div class="card-header">
          <h3>📋 Détails & indicateurs</h3>
          <small>Temps moyen, variations et conseils</small>
        </div>

        <div class="details-grid">
          <div class="detail">
            <div class="label">Taux de complétion</div>
            <div class="value">{{ dashboard?.courseProgress?.completionRate || '—' }}</div>
            <div class="muted">∆ {{ dashboard?.courseProgress?.completionRateChange || '—' }}</div>
          </div>
          <div class="detail">
            <div class="label">Temps moyen</div>
            <div class="value">{{ dashboard?.courseProgress?.averageTime || '—' }}</div>
            <div class="muted">∆ {{ dashboard?.courseProgress?.averageTimeChange || '—' }}</div>
          </div>
          <div class="detail">
            <div class="label">Engagement communautaire</div>
            <div class="value">{{ dashboard?.communityEngagement?.engagementRate || '—' }}</div>
            <div class="muted">
              ∆ {{ dashboard?.communityEngagement?.engagementRateChange || '—' }}
            </div>
          </div>
          <div class="detail">
            <div class="label">Dernier rafraîchissement</div>
            <div class="value">
              {{ loading ? 'En cours...' : lastRefresh }}
            </div>

            <div class="muted">Actualise pour mettre à jour</div>
          </div>
        </div>
      </div>

      <div class="card chart-card side">
        <div class="card-header">
          <h3>🏅 Répartition des badges</h3>
          <small>Types populaires</small>
        </div>
        <div class="chart-container small">
          <canvas
            baseChart
            [data]="{
              labels: badgesPieLabels,
              datasets: [
                { data: badgesPieData, backgroundColor: ['#e53935', '#ff8a80', '#ffffff'] }
              ]
            }"
            [options]="pieOptions"
            chartType="pie"
          >
          </canvas>
        </div>

        <div class="mini-stats">
          <div class="progress-wrap">
            <label>Progression parcours</label>
            <div class="doughnut">
              <canvas
                baseChart
                [data]="{
                  labels: ['Complété', 'Restant'],
                  datasets: [{ data: progressDoughnutData }]
                }"
                [options]="doughnutOptions"
                chartType="doughnut"
              >
              </canvas>
              <div class="doughnut-center">{{ completionRate }}</div>
            </div>
          </div>

          <div class="category-buttons">
            <button (click)="loadCategoryProgress('ENVIRONNEMENT')" class="btn-ghost small">
              ENVIRONNEMENT
            </button>
            <button (click)="loadCategoryProgress('DROIT_DU_CITOYEN')" class="btn-ghost small">
              DROIT
            </button>
            <button (click)="loadCategoryProgress('DEVOIR_DU_CITOYEN')" class="btn-ghost small">
              DEVOIR
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Loading / error -->
  <div class="overlay" *ngIf="loading">
    <div class="spinner-large"></div>
    <div class="loading-text">Chargement du dashboard...</div>
  </div>

  <div class="error" *ngIf="error">{{ error }}</div>
</div>
