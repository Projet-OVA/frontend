<!-- src/app/features/dashboard.html -->
<div class="dashboard-page">
  <header class="header">
    <div class="header-left">
      <h1>‚ú® Tableau de bord</h1>
      <p class="subtitle">Aper√ßu global ‚Äî utilisateurs, badges, progression & engagement</p>
    </div>
    <div class="header-actions">
      <button class="btn-ghost" (click)="refresh()" [disabled]="loading">
        üîÑ {{ refreshing ? 'Actualisation...' : 'Actualiser' }}
      </button>
    </div>
  </header>

  <main class="grid">
    <!-- TOP METRICS -->
    <section class="metrics">
      <div class="card metric-card pulse">
        <div class="metric-title">Utilisateurs totaux</div>
        <div class="metric-value">{{ totalUsers | number }}</div>
        <div class="metric-sub">Actifs : {{ activeUsers | number }}</div>
      </div>

      <div class="card metric-card pulse delay">
        <div class="metric-title">√âv√©nements</div>
        <div class="metric-value">{{ totalEvents }}</div>
        <div class="metric-sub">Organis√©s / enregistr√©s</div>
      </div>

      <div class="card metric-card pulse delay-more">
        <div class="metric-title">Badges attribu√©s</div>
        <div class="metric-value">{{ totalBadges }}</div>
        <div class="metric-sub">R√©partition dans le camembert</div>
      </div>

      <div class="card metric-card">
        <div class="metric-title">Engagement</div>
        <div class="metric-value">{{ engagementRate }}</div>
        <div class="metric-sub">
          Variation: {{ dashboard?.communityEngagement?.engagementRateChange || '0%' }}
        </div>
      </div>
    </section>

    <!-- CHARTS ROW -->
    <section class="charts-row">
      <div class="card wide">
        <div class="card-header">
          <h3>üìã D√©tails & indicateurs</h3>
          <small>Temps moyen, variations et conseils</small>
        </div>

        <div class="details-grid">
          <div class="detail">
            <div class="label">Taux de compl√©tion</div>
            <div class="value">{{ dashboard?.courseProgress?.completionRate || '‚Äî' }}</div>
            <div
              class="muted"
              [class.positive]="isPositive(dashboard?.courseProgress?.completionRateChange)"
              [class.negative]="isNegative(dashboard?.courseProgress?.completionRateChange)"
            >
              ‚àÜ {{ dashboard?.courseProgress?.completionRateChange || '0%' }}
            </div>
          </div>
          <div class="detail">
            <div class="label">Temps moyen</div>
            <div class="value">{{ dashboard?.courseProgress?.averageTime || '‚Äî' }}</div>
            <div
              class="muted"
              [class.positive]="isNegative(dashboard?.courseProgress?.averageTimeChange)"
              [class.negative]="isPositive(dashboard?.courseProgress?.averageTimeChange)"
            >
              ‚àÜ {{ dashboard?.courseProgress?.averageTimeChange || '0%' }}
            </div>
          </div>
          <div class="detail">
            <div class="label">Engagement communautaire</div>
            <div class="value">{{ dashboard?.communityEngagement?.engagementRate || '‚Äî' }}</div>
            <div
              class="muted"
              [class.positive]="isPositive(dashboard?.communityEngagement?.engagementRateChange)"
              [class.negative]="isNegative(dashboard?.communityEngagement?.engagementRateChange)"
            >
              ‚àÜ {{ dashboard?.communityEngagement?.engagementRateChange || '0%' }}
            </div>
          </div>
          <div class="detail">
            <div class="label">Dernier rafra√Æchissement</div>
            <div class="value">{{ loading ? 'En cours...' : lastRefresh }}</div>
            <div class="muted">Actualise pour mettre √† jour</div>
          </div>
        </div>
      </div>

      <div class="side-cards">
        <!-- Carte R√©partition des badges -->
        <div class="card chart-card">
          <div class="card-header">
            <h3>üèÖ R√©partition des badges</h3>
            <small>Types populaires</small>
          </div>
          <div class="chart-container">
            <canvas
              baseChart
              [data]="{
                labels: badgesPieLabels,
                datasets: [
                  {
                    data: badgesPieData,
                    backgroundColor: ['#FF9800', '#F57C00', '#E65100', '#FFB74D', '#FFA726']
                  }
                ]
              }"
              [options]="pieOptions"
              chartType="pie"
            >
            </canvas>
          </div>
        </div>

        <!-- Carte Progression Globale -->
        <div class="card progress-card">
          <div class="card-header">
            <h3>üìä Progression Globale</h3>
            <small>Avancement par cat√©gorie</small>
          </div>

          <div class="category-selector">
            <h4>Filtrer par cat√©gorie:</h4>
            <div class="category-buttons">
              <button
                (click)="loadCategoryProgress('ENVIRONNEMENT')"
                class="btn-category"
                [class.active]="activeCategory === 'ENVIRONNEMENT'"
              >
                üå± ENVIRONNEMENT
              </button>
              <button
                (click)="loadCategoryProgress('DROIT_DU_CITOYEN')"
                class="btn-category"
                [class.active]="activeCategory === 'DROIT_DU_CITOYEN'"
              >
                ‚öñÔ∏è DROIT
              </button>
              <button
                (click)="loadCategoryProgress('DEVOIR_DU_CITOYEN')"
                class="btn-category"
                [class.active]="activeCategory === 'DEVOIR_DU_CITOYEN'"
              >
                üìö DEVOIR
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- NOUVELLE SECTION : 3 DIAGRAMMES DE PROGRESSION -->
    <section class="progress-diagrams">
      <!-- ENVIRONNEMENT - Diagramme circulaire -->
      <div class="card diagram-card environment-card">
        <div class="card-header">
          <h3>üå± Progression Environnement</h3>
          <small
            >{{ getCategoryStats('ENVIRONNEMENT') }} -
            {{ categoryProgress['ENVIRONNEMENT'].progressPercentage }}% compl√©t√©</small
          >
        </div>
        <div class="chart-container">
          <canvas #envChart width="400" height="300"></canvas>
        </div>
        <div class="diagram-stats">
          <div class="stat-item">
            <span class="stat-value">{{ categoryProgress['ENVIRONNEMENT'].completedQuizzes }}</span>
            <span class="stat-label">Quizzes compl√©t√©s</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ categoryProgress['ENVIRONNEMENT'].totalQuizzes }}</span>
            <span class="stat-label">Quizzes total</span>
          </div>
        </div>
      </div>

      <!-- DROIT_DU_CITOYEN - Diagramme barres horizontales -->
      <div class="card diagram-card droit-card">
        <div class="card-header">
          <h3>‚öñÔ∏è Progression Droit du Citoyen</h3>
          <small
            >{{ getCategoryStats('DROIT_DU_CITOYEN') }} -
            {{ categoryProgress['DROIT_DU_CITOYEN'].progressPercentage }}% compl√©t√©</small
          >
        </div>
        <div class="chart-container">
          <canvas #droitChart width="400" height="300"></canvas>
        </div>
        <div class="diagram-stats">
          <div class="stat-item">
            <span class="stat-value">{{
              categoryProgress['DROIT_DU_CITOYEN'].completedQuizzes
            }}</span>
            <span class="stat-label">Quizzes compl√©t√©s</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ categoryProgress['DROIT_DU_CITOYEN'].totalQuizzes }}</span>
            <span class="stat-label">Quizzes total</span>
          </div>
        </div>
      </div>

      <!-- DEVOIR_DU_CITOYEN - Diagramme jauge circulaire -->
      <div class="card diagram-card devoir-card">
        <div class="card-header">
          <h3>üìö Progression Devoir du Citoyen</h3>
          <small
            >{{ getCategoryStats('DEVOIR_DU_CITOYEN') }} -
            {{ categoryProgress['DEVOIR_DU_CITOYEN'].progressPercentage }}% compl√©t√©</small
          >
        </div>
        <div class="chart-container">
          <canvas #devoirChart width="400" height="300"></canvas>
        </div>
        <div class="diagram-stats">
          <div class="stat-item">
            <span class="stat-value">{{
              categoryProgress['DEVOIR_DU_CITOYEN'].completedQuizzes
            }}</span>
            <span class="stat-label">Quizzes compl√©t√©s</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ categoryProgress['DEVOIR_DU_CITOYEN'].totalQuizzes }}</span>
            <span class="stat-label">Quizzes total</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Loading / error -->
  <div class="overlay" *ngIf="loading">
    <div class="spinner-large"></div>
    <div class="loading-text">Chargement du dashboard...</div>
  </div>

  <div class="error" *ngIf="error">{{ error }}</div>
</div>
